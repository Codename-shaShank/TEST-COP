name: CI Auto-Fix

on:
  pull_request:
    types: [opened, reopened, synchronize]
    paths:
      - 'Gemfile'
      - 'Gemfile.lock'
      - '.github/workflows/ci.yml'
      - 'bin/**'

jobs:
  auto-fix:
    if: ${{ github.actor == 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run tests (initial)
        id: initial_tests
        continue-on-error: true
        run: |
          bin/rails test:prepare 2>&1 | tee test_output.txt
          bin/rails test 2>&1 | tee -a test_output.txt

      - name: Analyze test output
        run: |
          echo "## CI Failure Analysis" > analysis.txt
          echo "" >> analysis.txt
          
          # Check for Ruby version mismatch
          if grep -q "Ruby version.*but your Gemfile specified" test_output.txt 2>/dev/null; then
            echo "âŒ **Ruby Version Mismatch Detected**" >> analysis.txt
            grep "Ruby version" test_output.txt >> analysis.txt || true
          fi
          
          # Check for permission errors
          if grep -q "Permission denied" test_output.txt 2>/dev/null; then
            echo "âŒ **Permission Error Detected**" >> analysis.txt
            grep -B2 -A2 "Permission denied" test_output.txt >> analysis.txt || true
          fi
          
          # Check for gem errors
          if grep -q "bundler\|gem" test_output.txt 2>/dev/null; then
            echo "âŒ **Gem/Bundler Issue Detected**" >> analysis.txt
          fi
          
          cat analysis.txt

      - name: Set up Ruby for fix attempt
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Generate fixes with Copilot
        id: generate_fixes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Read the logs
          LOGS=$(cat test_output.txt 2>/dev/null || echo "No logs available")
          
          # Get current Gemfile content
          GEMFILE=$(cat Gemfile)
          
          # Get current CI workflow
          CI_WORKFLOW=$(cat .github/workflows/ci.yml)
          
          # Create comprehensive prompt
          PROMPT=$(cat <<'PROMPT_END'
          You are a Ruby on Rails DevOps expert. The CI pipeline failed on a Dependabot PR branch.
          
          **CI Logs:**
          PROMPT_END
          echo "$LOGS" | head -300
          cat <<'PROMPT_END'
          
          **Current Gemfile:**
          PROMPT_END
          echo "$GEMFILE"
          cat <<'PROMPT_END'
          
          **Current CI Workflow:**
          PROMPT_END
          echo "$CI_WORKFLOW"
          cat <<'PROMPT_END'
          
          **Your task:**
          Analyze the CI failure and provide fixes. Common issues:
          1. Ruby version mismatch â†’ Change exact version to pessimistic constraint (e.g., "3.2.0" â†’ "~> 3.2.0")
          2. Permission denied on bin/ scripts â†’ Already documented, will be fixed separately
          3. Bundler issues â†’ Adjust bundler-cache or ruby-version settings
          4. Missing dependencies â†’ Add to Gemfile or CI workflow
          
          Format your response as:
          
          FIX_TYPE: [ruby_version|ci_config|gemfile_dependency|permissions]
          FILE: path/to/file
          ```language
          complete fixed file content here
          ```
          
          EXPLANATION: Brief one-line explanation
          
          Provide ALL necessary fixes to make CI pass.
          PROMPT_END
          )
          
          # Call GitHub Models API
          gh models run claude-3-5-sonnet-20241022 --input "$PROMPT" > fixes.txt 2>&1 || echo "Failed to get AI suggestions"
          
          cat fixes.txt
          echo "has_fixes=true" >> $GITHUB_OUTPUT

      - name: Apply fixes
        if: steps.generate_fixes.outputs.has_fixes == 'true'
        run: |
          # Parse and apply the fixes from fixes.txt
          # This is a simplified parser - you might want to make it more robust
          
          # Check if Ruby version fix is needed
          if grep -q "ruby.*3.2.0" Gemfile && grep -q "FIX_TYPE: ruby_version" fixes.txt; then
            echo "Applying Ruby version fix..."
            sed -i 's/ruby "3.2.0"/ruby "~> 3.2.0"/' Gemfile
          fi
          
          # Add execute permissions to bin scripts if needed
          if [ -d bin ]; then
            chmod +x bin/* 2>/dev/null || true
            git update-index --chmod=+x bin/* 2>/dev/null || true
          fi

      - name: Update gem diff markdown with auto-fix changes
        if: steps.generate_fixes.outputs.has_fixes == 'true'
        run: |
          AUTO_FIX_FILES=$(git diff --name-only)
          if [ -n "$AUTO_FIX_FILES" ]; then
            printf "The CI auto-fix applied the following changes:\n\n" > auto_fix_summary.md
            printf "%s\n" "$AUTO_FIX_FILES" | sed 's/^/- /' >> auto_fix_summary.md
            AUTO_FIX_SUMMARY="$(cat auto_fix_summary.md)"
            AUTO_FIX_SUMMARY="$AUTO_FIX_SUMMARY" ruby .github/scripts/gem_diff.rb > gem_review.md 2>&1 || true
          fi

      - name: Test fixes locally
        id: test_fixes
        continue-on-error: true
        run: |
          bundle install --quiet
          bin/rails test:prepare 2>&1 || echo "Test prepare completed"
          echo "fixes_applied=true" >> $GITHUB_OUTPUT

      - name: Comment on Dependabot PR with fixes
        if: steps.test_fixes.outputs.fixes_applied == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          git status --porcelain
          
          DIFF=$(git diff)
          if [ -z "$DIFF" ]; then
            echo "No changes to report."
            exit 0
          fi
          
          COMMENT_BODY=$(cat <<'PR_END'
          ## ðŸ¤– Automated CI Fix Suggestions
          
          I ran the test suite for this Dependabot PR and generated suggested fixes based on the failures.
          
          ### Analysis
          PR_END
          cat analysis.txt || echo "Analysis not available"
          cat <<'PR_END'
          
          ### Gem diff summary
          PR_END
          if [ -f gem_review.md ]; then
            sed -n '1,120p' gem_review.md
          else
            echo "gem_review.md not available"
          fi
          cat <<'PR_END'
          
          ### Suggested patch
          ```diff
          PR_END
          printf "%s\n" "$DIFF"
          cat <<'PR_END'
          ```
          
          ---
          If you'd like, reply with **@copilot apply** and I can open a PR with these changes.
          PR_END
          )
          
          gh pr comment "$PR_NUMBER" --body "$COMMENT_BODY"

      - name: Notify on failure
        if: failure()
        run: |
          echo "::warning::Auto-fix workflow failed. Manual intervention required."
          echo "Check the logs and apply fixes manually."
